<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenGold | Admin Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap');
        body { font-family: 'Montserrat', sans-serif; background-color: #f3f4f6; }
        
        .sidebar { width: 260px; background: #111827; height: 100vh; position: fixed; left: 0; top: 0; color: #9ca3af; transition: all 0.3s; z-index: 50; }
        .nav-item { padding: 12px 20px; margin: 4px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.2s; }
        .nav-item:hover, .nav-item.active { background: #1f2937; color: #10b981; }
        .main-content { margin-left: 260px; padding: 2rem; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .live-badge { background: #dcfce7; color: #15803d; padding: 4px 12px; border-radius: 99px; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .pulse { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 0 rgba(34, 197, 94, 0.4); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .badge-pending { background: #fef3c7; color: #d97706; }
        .badge-delivered { background: #dcfce7; color: #166534; }
        
        /* Permission Error Modal */
        #permission-modal { background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
    </style>
</head>
<body>

    <!-- Permission Error Modal -->
    <div id="permission-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 text-center">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                <i class="fas fa-lock"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Database Locked</h2>
            <p class="text-gray-600 mb-6">Your Firebase security rules are blocking access. Please check the Console.</p>
            <button onclick="location.reload()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition">
                Retry Connection
            </button>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-6 flex items-center gap-3 text-white mb-6">
            <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center"><i class="fas fa-leaf"></i></div>
            <span class="font-bold text-xl tracking-wide">GreenGold</span>
        </div>

        <div class="px-4 mb-2 text-xs font-bold uppercase tracking-wider text-gray-500">Overview</div>
        <div class="nav-item active"><i class="fas fa-chart-pie"></i> Dashboard</div>
        <div class="nav-item"><i class="fas fa-globe"></i> Live Traffic</div>

        <div class="px-4 mb-2 mt-6 text-xs font-bold uppercase tracking-wider text-gray-500">Management</div>
        <div class="nav-item"><i class="fas fa-shopping-basket"></i> Orders <span id="pending-badge" class="ml-auto bg-red-500 text-white text-[10px] px-2 rounded-full hidden">0</span></div>
        <div class="nav-item"><i class="fas fa-users"></i> Customers</div>
        <div class="nav-item"><i class="fas fa-coins"></i> Gold SIPs</div>

        <div class="absolute bottom-0 w-full p-4">
            <button onclick="logout()" class="w-full bg-gray-800 text-gray-400 py-3 rounded-lg hover:text-white hover:bg-red-900/50 transition flex items-center justify-center gap-2">
                <i class="fas fa-sign-out-alt"></i> Secure Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
                <p class="text-sm text-gray-500">Real-time farm & business metrics</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="live-badge">
                    <div class="pulse"></div> Live System
                </div>
                <div class="w-10 h-10 rounded-full bg-gray-200 border-2 border-green-500 overflow-hidden">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=10b981&color=fff" alt="Admin">
                </div>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card border-l-4 border-green-500">
                <p class="text-gray-500 text-xs font-bold uppercase">Total Revenue</p>
                <h3 class="text-2xl font-bold text-gray-800 mt-1">₹<span id="stat-revenue">0</span></h3>
            </div>
            <div class="card border-l-4 border-yellow-500">
                <p class="text-gray-500 text-xs font-bold uppercase">Pending Orders</p>
                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="stat-pending">0</h3>
            </div>
            <div class="card border-l-4 border-blue-500">
                <p class="text-gray-500 text-xs font-bold uppercase">Active Customers</p>
                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="stat-users">0</h3>
            </div>
            <div class="card border-l-4 border-purple-500 relative overflow-hidden">
                <p class="text-gray-500 text-xs font-bold uppercase">Live Site Visits</p>
                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="stat-visits">0</h3>
                <i class="fas fa-eye absolute right-4 bottom-4 text-4xl text-purple-100"></i>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left: Orders Table -->
            <div class="lg:col-span-2 card">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-lg text-gray-800">Recent Orders</h3>
                    <button class="text-green-600 text-sm font-bold hover:underline">View All</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                            <tr>
                                <th class="p-3">Order ID</th>
                                <th class="p-3">Customer</th>
                                <th class="p-3">Items</th>
                                <th class="p-3">Amount</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Action</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body" class="divide-y divide-gray-100">
                            <!-- JS Populated -->
                            <tr><td colspan="6" class="p-4 text-center text-gray-400">Loading live orders...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Right: Live Chart -->
            <div class="card">
                <h3 class="font-bold text-lg text-gray-800 mb-4">Traffic Real-Time</h3>
                <canvas id="trafficChart" height="250"></canvas>
                <div class="mt-4 text-center">
                    <p class="text-xs text-gray-400">Updates every 3 seconds</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // 1. CONFIGURATION (User Provided)
        const firebaseConfig = {
            apiKey: "AIzaSyCn97KMDw04cR7BI12WIrg9-5PRiJ8vjMo",
            authDomain: "projectgreengold-79577.firebaseapp.com",
            projectId: "projectgreengold-79577",
            storageBucket: "projectgreengold-79577.firebasestorage.app",
            messagingSenderId: "143016682488",
            appId: "1:143016682488:web:c97e001d782498ea5bac0d",
            measurementId: "G-FDD32RYNGQ"
        };

        // Init Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch(e) { console.error("Firebase Error", e); }

        // 2. DASHBOARD LOGIC
        if (auth && db) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    initListeners(db);
                } else {
                    // Auto-sign in anonymously if not logged in to view public stats (if rules allow)
                    signInAnonymously(auth).catch((error) => {
                        console.error("Auth Failed:", error);
                        if(error.code === 'auth/operation-not-allowed') {
                            document.getElementById('permission-modal').classList.remove('hidden');
                        }
                    });
                }
            });
        }

        function initListeners(db) {
            // A. Live Visits
            try {
                onSnapshot(doc(db, "stats", "visits"), (doc) => {
                    if(doc.exists()) {
                        const count = doc.data().count;
                        const el = document.getElementById('stat-visits');
                        if(el) {
                            el.innerText = count;
                            updateChart(count);
                        }
                    }
                }, handlePermissionError);
            } catch(e) {}

            // B. Orders Listener
            const ordersQ = query(collection(db, "orders"), orderBy("date", "desc"));
            onSnapshot(ordersQ, (snapshot) => {
                const tbody = document.getElementById('orders-table-body');
                let pendingCount = 0;
                let totalRev = 0;
                
                if (tbody) tbody.innerHTML = ""; 

                snapshot.forEach(docSnap => {
                    const o = docSnap.data();
                    const id = docSnap.id;
                    
                    if(o.status === "Pending") pendingCount++;
                    if(o.status === "Delivered") totalRev += (o.total || 0);

                    const statusBadge = o.status === "Delivered" 
                        ? `<span class="badge badge-delivered">Delivered</span>` 
                        : `<span class="badge badge-pending">Pending</span>`;
                    
                    const actionBtn = o.status === "Pending"
                        ? `<button onclick="markDelivered('${id}')" class="text-blue-600 hover:text-blue-800 font-bold text-xs">✔ Dispatch</button>`
                        : `<span class="text-gray-300">-</span>`;

                    const row = `
                        <tr class="hover:bg-gray-50 transition">
                            <td class="p-3 font-mono text-gray-500">#${id.substr(0,5)}</td>
                            <td class="p-3 font-bold text-gray-800">${o.userName || 'Guest'}</td>
                            <td class="p-3 text-gray-600 truncate max-w-[150px]">${o.items ? o.items.join(", ") : "Mixed Veggies"}</td>
                            <td class="p-3 font-bold">₹${o.total}</td>
                            <td class="p-3">${statusBadge}</td>
                            <td class="p-3">${actionBtn}</td>
                        </tr>
                    `;
                    if (tbody) tbody.innerHTML += row;
                });

                document.getElementById('stat-pending').innerText = pendingCount;
                document.getElementById('stat-revenue').innerText = totalRev.toLocaleString();
                
                const badge = document.getElementById('pending-badge');
                if(badge) {
                    badge.innerText = pendingCount;
                    badge.classList.toggle('hidden', pendingCount === 0);
                }
            }, handlePermissionError);

            // C. Users Listener
            onSnapshot(collection(db, "users"), (snap) => {
                const el = document.getElementById('stat-users');
                if(el) el.innerText = snap.size;
            }, (e) => { /* Silent fail */ });
        }

        function handlePermissionError(error) {
            console.error("Firestore Error:", error);
            if (error.code === 'permission-denied') {
                document.getElementById('permission-modal').classList.remove('hidden');
            }
        }

        // 3. ACTION FUNCTIONS
        window.markDelivered = async (id) => {
            if(confirm("Confirm delivery dispatch?")) {
                if(db) await updateDoc(doc(db, "orders", id), { status: "Delivered" });
            }
        };

        window.logout = async () => {
            if(auth) await signOut(auth);
            window.location.href = "index.html"; 
        }

        // 4. LIVE CHART SETUP
        const ctx = document.getElementById('trafficChart');
        let trafficChart;
        if(ctx) {
            trafficChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: Array(10).fill(''),
                    datasets: [{
                        label: 'Active Users',
                        data: Array(10).fill(0),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, display: false }, x: { display: false } },
                    animation: { duration: 0 }
                }
            });
        }

        function updateChart(newValue) {
            if(!trafficChart) return;
            const data = trafficChart.data.datasets[0].data;
            data.push(newValue); // Add new
            data.shift(); // Remove old
            trafficChart.update();
        }

    </script>
</body>
</html>