<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenGold | Admin Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap');
        body { font-family: 'Montserrat', sans-serif; background-color: #f3f4f6; overflow-x: hidden; }
        
        /* Layout Fixes for Mobile */
        .sidebar { width: 260px; background: #111827; height: 100vh; position: fixed; left: 0; top: 0; color: #9ca3af; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 60; }
        .sidebar.closed { transform: translateX(-100%); }
        
        .nav-item { padding: 12px 20px; margin: 4px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.2s; font-size: 14px; }
        .nav-item:hover, .nav-item.active { background: #1f2937; color: #10b981; }
        
        .main-content { transition: all 0.3s; padding: 1rem; min-height: 100vh; }
        @media (min-width: 1024px) { 
            .main-content { margin-left: 260px; padding: 2rem; } 
            .sidebar.closed { transform: translateX(0); } 
        }

        .card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .view-section { display: block; animation: fadeIn 0.3s ease-out; }
        .view-section.hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .badge { padding: 4px 10px; border-radius: 99px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .badge-pending { background: #fef3c7; color: #d97706; }
        .badge-delivered { background: #dcfce7; color: #166534; }
        .badge-sip { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
    </style>
</head>
<body>

    <!-- Mobile Header -->
    <div class="lg:hidden bg-[#111827] text-white p-4 flex justify-between items-center sticky top-0 z-[55] shadow-lg">
        <div class="flex items-center gap-2">
            <i class="fas fa-leaf text-green-500"></i>
            <span class="font-bold tracking-tight text-sm uppercase">GreenGold Admin</span>
        </div>
        <button onclick="toggleSidebar()" class="w-10 h-10 flex items-center justify-center rounded-lg bg-gray-800"><i class="fas fa-bars"></i></button>
    </div>

    <!-- Sidebar Backdrop -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-[58] hidden lg:hidden backdrop-blur-sm"></div>

    <!-- Sidebar Navigation -->
    <div id="sidebar" class="sidebar closed lg:translate-x-0">
        <div class="p-8 flex items-center gap-3 text-white mb-6 border-b border-gray-800">
            <div class="w-10 h-10 bg-green-600 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-leaf"></i></div>
            <div>
                <span class="font-bold text-xl block">GreenGold</span>
                <span class="text-[10px] text-gray-500 tracking-[0.2em] uppercase">Control Center</span>
            </div>
        </div>

        <div class="px-6 mb-2 text-[10px] font-bold uppercase tracking-widest text-gray-500">Business</div>
        <div onclick="switchAdminView('dashboard')" class="nav-item active" id="nav-dashboard"><i class="fas fa-chart-pie w-5"></i> Dashboard</div>
        <div onclick="switchAdminView('traffic')" class="nav-item" id="nav-traffic"><i class="fas fa-globe w-5"></i> Live Traffic</div>

        <div class="px-6 mb-2 mt-8 text-[10px] font-bold uppercase tracking-widest text-gray-500">Management</div>
        <div onclick="switchAdminView('orders')" class="nav-item" id="nav-orders">
            <i class="fas fa-shopping-basket w-5"></i> Orders 
            <span id="pending-badge" class="ml-auto bg-red-500 text-white text-[10px] px-2 rounded-full hidden">0</span>
        </div>
        <div onclick="switchAdminView('customers')" class="nav-item" id="nav-customers"><i class="fas fa-users w-5"></i> Customers</div>
        <div onclick="switchAdminView('sips')" class="nav-item" id="nav-sips"><i class="fas fa-coins w-5"></i> Gold SIPs</div>

        <div class="absolute bottom-0 w-full p-6 bg-[#0f172a]">
            <button onclick="logout()" class="w-full bg-red-900/20 text-red-400 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 hover:bg-red-900/40 transition">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <header class="flex justify-between items-center mb-8">
            <div class="hidden lg:block">
                <h1 class="text-2xl font-bold text-gray-800" id="page-title">Dashboard</h1>
                <p class="text-xs text-gray-400 mt-1 uppercase tracking-widest">Real-time data visualization</p>
            </div>
            <div class="flex items-center gap-4 ml-auto lg:ml-0">
                <div class="bg-white px-4 py-2 rounded-full shadow-sm flex items-center gap-3">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-[10px] font-bold text-gray-600 uppercase">Live Metrics</span>
                </div>
                <img src="https://ui-avatars.com/api/?name=Admin&background=111827&color=fff" class="w-10 h-10 rounded-xl shadow-md border-2 border-white">
            </div>
        </header>

        <!-- DASHBOARD VIEW -->
        <div id="dashboard-view" class="view-section">
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                <div class="card border-b-4 border-green-500"><p class="text-gray-400 text-[10px] uppercase font-bold mb-1">Total Revenue</p><h3 class="text-xl md:text-2xl font-bold text-gray-800" id="stat-revenue">₹0</h3></div>
                <div class="card border-b-4 border-yellow-500"><p class="text-gray-400 text-[10px] uppercase font-bold mb-1">Pending Orders</p><h3 class="text-xl md:text-2xl font-bold text-gray-800" id="stat-pending">0</h3></div>
                <div class="card border-b-4 border-blue-500"><p class="text-gray-400 text-[10px] uppercase font-bold mb-1">Active Users</p><h3 class="text-xl md:text-2xl font-bold text-gray-800" id="stat-users">0</h3></div>
                <div class="card border-b-4 border-purple-500"><p class="text-gray-400 text-[10px] uppercase font-bold mb-1">Total Visits</p><h3 class="text-xl md:text-2xl font-bold text-gray-800" id="stat-visits">0</h3></div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                <div class="lg:col-span-2 card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-gray-800">Recent Orders</h3>
                        <button onclick="switchAdminView('orders')" class="text-green-600 text-xs font-bold hover:underline">View All</button>
                    </div>
                    <div class="overflow-x-auto -mx-5 md:mx-0">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-gray-50 text-gray-400 uppercase font-bold border-b">
                                <tr><th class="p-4">Customer</th><th class="p-4">Total</th><th class="p-4">Status</th></tr>
                            </thead>
                            <tbody id="dash-orders-body" class="divide-y divide-gray-50">
                                <tr><td colspan="3" class="p-8 text-center text-gray-400">Loading live data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card flex flex-col">
                    <h3 class="font-bold text-gray-800 mb-4">Traffic Stream</h3>
                    <div class="flex-grow h-48"><canvas id="trafficSmall"></canvas></div>
                    <p class="text-[10px] text-center text-gray-400 mt-4 italic uppercase">Real-time Heartbeat Active</p>
                </div>
            </div>
        </div>

        <!-- TRAFFIC VIEW -->
        <div id="traffic-view" class="view-section hidden">
            <div class="card h-[400px] md:h-[600px] flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-800">Advanced Site Traffic Metrics</h3>
                    <div class="bg-green-50 text-green-700 px-3 py-1 rounded-full text-[10px] font-bold uppercase">Real-time Data Pulse</div>
                </div>
                <div class="flex-grow">
                    <canvas id="trafficBig"></canvas>
                </div>
            </div>
        </div>

        <!-- ORDERS VIEW -->
        <div id="orders-view" class="view-section hidden">
            <div class="card overflow-hidden p-0">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-xs md:text-sm">
                        <thead class="bg-gray-50 text-gray-400 font-bold uppercase">
                            <tr><th class="p-4">Date</th><th class="p-4">Customer</th><th class="p-4">Items</th><th class="p-4 text-right">Total</th><th class="p-4 text-center">Action</th></tr>
                        </thead>
                        <tbody id="all-orders-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CUSTOMERS VIEW -->
        <div id="customers-view" class="view-section hidden">
            <div class="card overflow-hidden p-0">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-xs md:text-sm">
                        <thead class="bg-gray-50 text-gray-400 font-bold uppercase">
                            <tr><th class="p-4">Customer</th><th class="p-4">Email</th><th class="p-4 text-right">Gold Balance</th></tr>
                        </thead>
                        <tbody id="all-users-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SIPs VIEW -->
        <div id="sips-view" class="view-section hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="card bg-yellow-50 border border-yellow-200">
                    <p class="text-[10px] text-yellow-600 font-bold uppercase tracking-widest">Total Gold Distributed</p>
                    <h3 class="text-3xl font-extrabold text-yellow-800 mt-2" id="stat-total-gold">0.000g</h3>
                    <p class="text-[10px] text-yellow-700 mt-1 opacity-70 italic">Calculated from user vaults</p>
                </div>
                <div class="card bg-indigo-50 border border-indigo-200">
                    <p class="text-[10px] text-indigo-600 font-bold uppercase tracking-widest">Recurring SIP Revenue</p>
                    <h3 class="text-3xl font-extrabold text-indigo-800 mt-2" id="stat-total-sip">₹0</h3>
                    <p class="text-[10px] text-indigo-700 mt-1 opacity-70 italic">Total monthly commitment</p>
                </div>
            </div>
            <div class="card overflow-hidden p-0">
                <div class="p-6 border-b border-gray-100"><h3 class="font-bold text-gray-800">Portfolio Details</h3></div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-xs md:text-sm">
                        <thead class="bg-gray-50 text-gray-400 font-bold uppercase">
                            <tr><th class="p-4">ID</th><th class="p-4">Amount</th><th class="p-4">Estimated Gold</th><th class="p-4">Status</th></tr>
                        </thead>
                        <tbody id="all-sips-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, collectionGroup } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCn97KMDw04cR7BI12WIrg9-5PRiJ8vjMo", 
            authDomain: "projectgreengold-79577.firebaseapp.com", 
            projectId: "projectgreengold-79577", 
            storageBucket: "projectgreengold-79577.firebasestorage.app", 
            messagingSenderId: "143016682488", 
            appId: "1:143016682488:web:c97e001d782498ea5bac0d", 
            measurementId: "G-FDD32RYNGQ" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => { 
            if (user) initListeners(db); 
            else signInAnonymously(auth).catch(e => console.error(e)); 
        });

        window.toggleSidebar = () => { 
            document.getElementById('sidebar').classList.toggle('closed'); 
            document.getElementById('sidebar-overlay').classList.toggle('hidden'); 
        };

        window.switchAdminView = (view) => {
            const titles = { 'dashboard':'Dashboard Overview', 'traffic':'Site Traffic Analysis', 'orders':'Order Management', 'customers':'Customer Database', 'sips':'Gold SIP Portfolio' };
            document.getElementById('page-title').innerText = titles[view];
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(view + '-view').classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + view).classList.add('active');
            if(window.innerWidth < 1024) toggleSidebar();
        };

        let currentVisits = 0;

        function initListeners(db) {
            // Visits
            onSnapshot(doc(db, "stats", "visits"), d => { 
                currentVisits = d.data()?.count || 0; 
                document.getElementById('stat-visits').innerText = currentVisits; 
            });

            // Orders
            onSnapshot(query(collection(db, "orders")), snap => {
                const sorted = snap.docs.sort((a,b)=>b.data().date.toMillis() - a.data().date.toMillis());
                let pending = 0; let rev = 0;
                document.getElementById('all-orders-body').innerHTML = "";
                document.getElementById('dash-orders-body').innerHTML = "";
                
                sorted.forEach(docSnap => {
                    const o = docSnap.data(); const id = docSnap.id;
                    if(o.status === 'Pending') pending++; else rev += o.total;
                    
                    const row = `<tr class="hover:bg-gray-50 border-b border-gray-100">
                        <td class="p-4 text-gray-500">${o.date.toDate().toLocaleDateString()}</td>
                        <td class="p-4 font-bold text-gray-800">${o.userName}</td>
                        <td class="p-4 truncate max-w-[120px] text-gray-500">${o.items}</td>
                        <td class="p-4 font-bold text-right">₹${o.total}</td>
                        <td class="p-4 text-center"><button onclick="dispatch('${id}')" class="text-blue-600 font-bold px-3 py-1 rounded hover:bg-blue-50">${o.status==='Pending'?'Dispatch':'✓'}</button></td>
                    </tr>`;
                    document.getElementById('all-orders-body').innerHTML += row;
                    
                    if(document.getElementById('dash-orders-body').children.length < 5) {
                        document.getElementById('dash-orders-body').innerHTML += `<tr>
                            <td class="p-4 font-bold text-gray-700">${o.userName}</td>
                            <td class="p-4 text-gray-900 font-medium text-right">₹${o.total}</td>
                            <td class="p-4 text-right"><span class="badge ${o.status==='Pending'?'badge-pending':'badge-delivered'}">${o.status}</span></td>
                        </tr>`;
                    }
                });
                document.getElementById('stat-pending').innerText = pending;
                document.getElementById('stat-revenue').innerText = "₹" + rev.toLocaleString();
                const b = document.getElementById('pending-badge'); b.innerText = pending; b.classList.toggle('hidden', pending===0);
            });

            // Customers
            onSnapshot(collection(db, "users"), snap => {
                let gold = 0; document.getElementById('all-users-body').innerHTML = "";
                snap.forEach(d => {
                    const u = d.data(); gold += (u.goldBalance || 0);
                    document.getElementById('all-users-body').innerHTML += `<tr class="hover:bg-gray-50">
                        <td class="p-4 font-bold text-gray-800">${u.name}</td>
                        <td class="p-4 text-gray-500">${u.email}</td>
                        <td class="p-4 font-bold text-yellow-600 text-right">${(u.goldBalance||0).toFixed(4)}g</td>
                    </tr>`;
                });
                document.getElementById('stat-users').innerText = snap.size;
                document.getElementById('stat-total-gold').innerText = gold.toFixed(3) + "g";
            });

            // SIPs (Collection Group)
            onSnapshot(collectionGroup(db, 'sips'), snap => {
                let val = 0; document.getElementById('all-sips-body').innerHTML = "";
                snap.forEach(d => {
                    const s = d.data(); const amount = parseInt(s.amount);
                    if(s.status === 'ACTIVE') val += amount;
                    const goldMg = ((amount/7250)*1000).toFixed(0);
                    document.getElementById('all-sips-body').innerHTML += `<tr>
                        <td class="p-4 font-mono text-gray-400">#${d.id.substr(0,4)}</td>
                        <td class="p-4 font-bold text-gray-800">₹${amount}</td>
                        <td class="p-4 text-yellow-700 font-bold">${goldMg}mg</td>
                        <td class="p-4"><span class="badge badge-sip">${s.status}</span></td>
                    </tr>`;
                });
                document.getElementById('stat-total-sip').innerText = "₹" + val.toLocaleString();
            }, e => {
                document.getElementById('all-sips-body').innerHTML = `<tr><td colspan="4" class="p-8 text-center text-red-500 font-medium">Firestore Index Required for Portfolio. Link in console.</td></tr>`;
            });

            // Charts Heartbeat Simulation
            const opt = { 
                responsive:true, 
                maintainAspectRatio:false, 
                animation:{duration:0}, 
                plugins:{legend:{display:false}}, 
                scales:{x:{display:false},y:{beginAtZero: true, display:false}} 
            };
            const chartDataSmall = { labels:Array(15).fill(''), datasets:[{ data:Array(15).fill(0), borderColor:'#10b981', fill:true, backgroundColor:'rgba(16,185,129,0.1)', tension:0.4, pointRadius: 0 }] };
            const chartDataBig = { labels:Array(40).fill(''), datasets:[{ label: 'Active Users', data:Array(40).fill(0), borderColor:'#10b981', fill:true, backgroundColor:'rgba(16,185,129,0.05)', tension:0.4, borderWidth: 2 }] };
            
            const c1 = new Chart(document.getElementById('trafficSmall').getContext('2d'), { type:'line', data: chartDataSmall, options:opt });
            const c2 = new Chart(document.getElementById('trafficBig').getContext('2d'), { type:'line', data: chartDataBig, options: { ...opt, scales: { x:{display:true, grid:{display:false}}, y:{display:true, grid:{color: '#f3f4f6'}}} } });
            
            setInterval(() => {
                const jitter = (currentVisits > 0) ? (Math.random() > 0.5 ? 1 : -1) : 0;
                const val = Math.max(0, currentVisits + jitter);
                
                c1.data.datasets[0].data.push(val);
                c1.data.datasets[0].data.shift();
                c1.update();
                
                c2.data.datasets[0].data.push(val);
                c2.data.datasets[0].data.shift();
                c2.update();
            }, 3000);
        }

        window.dispatch = async (id) => { 
            if(confirm("Mark this order as Delivered and dispatch items?")) {
                await updateDoc(doc(db, "orders", id), { status: "Delivered" }); 
            }
        };

        window.logout = async () => { 
            await signOut(auth); 
            window.location.href = "./index.html"; 
        };
    </script>
</body>
</html>
